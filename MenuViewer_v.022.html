<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CDSS Menu Viewer Demo</title>
  <style>
    table {
      border-collapse: collapse;
    }

    th,
    td {
      border: none;
      padding: 8px;
    }

    .bold {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <p>CDSS Menu Viewer Testing. Select menu below to begin.</p>

  <select id="filterDropdown">
  </select>

  <div id="resultContainer"></div>

  <script>
    // Fetch JSON Data
    function fetchData() {
      return fetch('OMJSON.json')
        .then(response => response.json())
        .catch(error => console.error('Error fetching JSON data:', error));
    }

    // Fetch Other JSON Data
    function fetchOtherData() {
      return fetch('ODJSON.json')
        .then(response => response.json())
        .catch(error => console.error('Error fetching other JSON data:', error));
    }

    // Populate Dropdown
    function populateDropdown(data) {
      const dropdown = document.getElementById('filterDropdown');

      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.Name;
        option.textContent = item.Name;
        dropdown.appendChild(option);
      });

      dropdown.addEventListener('change', filterData);
    }

    // Display item information
    function displayItemInfo(item, container) {
      const infoContainer = document.createElement('div');

      for (const key in item) {
        const label = document.createElement('strong');
        label.textContent = `${key}: `;
        const value = document.createElement('span');

        if (key === "Text" && !item.Text && item.Item) {
          fetchOtherData()
            .then(otherData => {
              const matchingItem = otherData.find(
                otherItem => otherItem.Name.trim().toLowerCase() === item.Item.trim().toLowerCase()
              );

              if (matchingItem) {
                value.textContent = matchingItem.DisplayText;
              } else {
                value.textContent = item[key];
              }
            })
            .catch(error => console.error('Error fetching other JSON data:', error));
        } else {
          value.textContent = item[key];
        }

        infoContainer.appendChild(label);
        infoContainer.appendChild(value);
        infoContainer.appendChild(document.createElement('br'));
      }

      container.innerHTML = '';
      container.appendChild(infoContainer);
    }

    // Function to handle row click event
    function handleRowClick(item, resultContainer) {
      fetchData()
        .then(jsonData => {
          const matchingOption = jsonData.find(
            dataItem => dataItem.Name.trim().toLowerCase() === item.Item.trim().toLowerCase()
          );

          if (matchingOption) {
            const dropdown = document.getElementById('filterDropdown');
            dropdown.value = item.Item;
            filterData({ target: dropdown }, jsonData);
          } else {
            fetchOtherData()
              .then(otherData => {
                const matchingItem = otherData.find(
                  otherItem => otherItem.Name.trim().toLowerCase() === item.Item.trim().toLowerCase()
                );

                if (matchingItem) {
                  displayItemInfo(matchingItem, resultContainer);
                }
              })
              .catch(error => console.error('Error fetching other JSON data:', error));
          }
        })
        .catch(error => console.error('Error fetching JSON data:', error));
    }

    // Updated filterData function
    function filterData(event, jsonData) {
      const selectedOption = event.target.value;

      // Fetch the JSON data if not passed as an argument
      if (!jsonData) {
        fetchData()
          .then(data => {
            filterData(event, data);
          })
          .catch(error => console.error('Error fetching JSON data:', error));
        return;
      }

      const otherData = fetchOtherData()
        .then(data => {
          // Filter the JSON data based on the selected option
          const filteredData = jsonData.filter(item => item.Name === selectedOption);

          const table = document.createElement('table');
          table.classList.add('table');

          const tbody = document.createElement('tbody');

          // Create the table body
          filteredData.forEach(content => {
            const { Contents } = content;
            const maxRow = Math.max(...Contents.map(item => item.Row));

            for (let row = 1; row <= maxRow; row++) {
              const bodyRow = document.createElement('tr');

              const matchingItem = Contents.find(item => item.Row === row);
              if (matchingItem) {
                const { Text, Item, Header } = matchingItem;

                const displayCell = document.createElement('td');

                if (!Text && Item) {
                  const matchingOption = data.find(
                    otherItem => otherItem.Name.trim().toLowerCase() === Item.trim().toLowerCase()
                  );

                  if (matchingOption) {
                    displayCell.textContent = matchingOption.DisplayText;
                    bodyRow.style.cursor = 'pointer';

                    // Add click event listener to display information
                    bodyRow.addEventListener('click', () => {
                      displayItemInfo(matchingOption, resultContainer);
                    });
                  } else {
                    displayCell.textContent = Item;
                  }
                } else {
                  displayCell.textContent = Text;
                }

                if (Header === 1) {
                  displayCell.classList.add('bold');
                }

                bodyRow.appendChild(displayCell);

                if (Item) {
                  bodyRow.style.cursor = 'pointer';
                  bodyRow.addEventListener('click', () => {
                    handleRowClick(matchingItem, resultContainer);
                  });
                }
              } else {
                // Add a blank cell for empty rows
                const emptyCell = document.createElement('td');
                bodyRow.appendChild(emptyCell);
              }

              tbody.appendChild(bodyRow);
            }
          });

          table.appendChild(tbody);

          const resultContainer = document.getElementById('resultContainer');
          resultContainer.innerHTML = '';
          resultContainer.appendChild(table);
        })
        .catch(error => console.error('Error fetching other JSON data:', error));
    }

    // Initial function to load data and populate the dropdown
    function initialize() {
      fetchData()
        .then(jsonData => {
          populateDropdown(jsonData);
          filterData({ target: dropdown }, jsonData);
        })
        .catch(error => console.error('Error fetching JSON data:', error));
    }

    // Call initialize function
    initialize();
  </script>
</body>

</html>

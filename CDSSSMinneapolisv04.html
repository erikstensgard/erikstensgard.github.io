<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minneapolis Antimicrobial CDSS</title>
  <style>
    /* Common styles */
    table {
      border-collapse: collapse;
      padding: 0; /* Reduce table padding */
    }

    th,
    td {
      border: none;
      padding: 4px; /* Reduce cell padding */
    }

    .clickable {
      color: blue;
      cursor: pointer;
    }

    .bold {
      font-weight: bold;
      background-color: lightblue; /* Set your desired background color here */
    }

    /* Header styles */
 #header {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1;
  display: flex;
  justify-content: flex-start;
  align-items: center;
}

#header button,
#header select {
  margin: 5px;
  flex: 0 0 auto;
}

#goBackButton {
  margin-left: 20px;
}

#mainMenuButton {
  margin-right: auto;
}

#goForwardButton {
  margin-right: 20px;
}

#filterDropdown {
  margin-right: 20px;
}


    /* Table styles */
    .table {
      table-layout: fixed;
      width: 100%;
    }

    .table td {
      white-space: nowrap; /* Disable text wrapping within a cell */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Media queries for responsive design */
    @media screen and (max-width: 1024px) {
      button,
      select {
        font-size: 12px;
      }
      #filterDropdown {
         width: 60%;
    }
    }
    
    @media screen and (max-width: 768px) {
      button,
      select {
        font-size: 10px;
      }
      #filterDropdown {
         width: 45%;
    }
    }

    @media screen and (max-width: 480px) {
      button,
      select {
        font-size: 8px;
      }
      #filterDropdown {
         width: 40%;
    }
    }
    
    @media screen and (max-width: 320px) {
      button,
      select {
        font-size: 6px;
      }
      #filterDropdown {
         width: 35%;
    }
    }
  </style>

</head>

<body>
  <div id="header">
    <button id="goBackButton">&larr; Go Back</button>
    <button id="mainMenuButton">Main Menu</button>
    <button id="goForwardButton">Go Forward &rarr;</button>
    <select id="filterDropdown"></select>
    <input type="text" id="searchInput" placeholder="Search..." />
  </div>

  <div id="resultContainer"></div>

  <div id="footer">
    <button id="downloadJSONButton">Download JSON</button>
  </div>

  <script>
    // Fetch OMJSON Data
async function fetchOMData() {
  const response = await fetch('MinneapolisOMJSON.json');
  const data = await response.json();
  return data;
}

// Fetch ODJSON Data
async function fetchODData() {
  const response = await fetch('MinneapolisODJSON.json');
  const data = await response.json();
  return data;
}

// Global variables
let omData = []; // OMJSON data
let odData = []; // ODJSON data
let selectedData = null; // Currently selected data
let history = []; // History of selected items
let forwardHistory = []; // History of forward selections
let historyIndex = -1; // Index of the current selection in the history

// Function to populate dropdown with OMJSON data
function populateDropdown(data) {
  const dropdown = document.getElementById('filterDropdown');
  dropdown.innerHTML = '';

  data.sort((a, b) => {
    const displayTextA = a.DisplayText || a.Name;
    const displayTextB = b.DisplayText || b.Name;
    return displayTextA.localeCompare(displayTextB);
  });

  data.forEach(item => {
    const option = document.createElement('option');
    option.value = item.Name;
    option.textContent = item.DisplayText || item.Name;
    dropdown.appendChild(option);
  });
}

// Function to adjust the font size based on column number and window/screen size
function adjustFontSize() {
  const tableRows = document.querySelectorAll('.table tr');
  const screenWidth = window.innerWidth;

  tableRows.forEach(row => {
    const columns = row.querySelectorAll('td');
    const maxColumns = columns.length;

    columns.forEach((column, index) => {
      let fontSize;

      if (screenWidth <= 320) {
        fontSize = `calc(10px - ${(maxColumns - 1) * 2}px)`; // Mobile (small)
      } else if (screenWidth <= 480) {
        fontSize = `calc(12px - ${(maxColumns - 1) * 2}px)`; // Mobile (iPhone)
      } else if (screenWidth <= 768) {
        fontSize = `calc(14px - ${(maxColumns - 1) * 2}px)`; // Mobile (iPad)
      } else if (screenWidth <= 1024) {
        fontSize = `calc(16px - ${(maxColumns - 1) * 2}px)`; // Tablet (iPad Pro)
      } else {
        fontSize = `calc(18px - ${(maxColumns - 1) * 2}px)`; // Desktop
      }

      column.style.fontSize = fontSize;
    });
  });
}

// Call the function initially
adjustFontSize();

// Function to handle row click event
function handleRowClick(item) {
  const matchingItem = omData.find(
    omItem => omItem.Name.trim().toLowerCase() === item.Item.trim().toLowerCase()
  );

  if (matchingItem) {
    selectedData = matchingItem;
    createOMTable(matchingItem);
    pushHistory(matchingItem.Name);
  } else {
    const matchingItemIndex = odData.findIndex(
      odItem => odItem.Name.trim().toLowerCase() === item.Item.trim().toLowerCase()
    );

    if (matchingItemIndex !== -1) {
      selectedData = odData[matchingItemIndex];
      createODTable(selectedData);
      pushHistory(selectedData.Item);
    }
    adjustFontSize();
  }

  // Scroll to the top of the table
  const resultContainer = document.getElementById('resultContainer');
  resultContainer.scrollTop = 0;
}

// Function to create the OMJSON table
function createOMTable(data) {
  const tableContainer = document.getElementById('tableContainer');
  tableContainer.innerHTML = '';

  const table = document.createElement('table');
  table.classList.add('table');

  const headerRow = document.createElement('tr');
  const headerName = document.createElement('th');
  headerName.textContent = 'Name';
  headerRow.appendChild(headerName);

  const headerValue = document.createElement('th');
  headerValue.textContent = 'Value';
  headerRow.appendChild(headerValue);

  table.appendChild(headerRow);

  const contents = data.OMData;
  contents.forEach(content => {
    const row = document.createElement('tr');

    const name = document.createElement('td');
    name.textContent = content.Name;
    row.appendChild(name);

    const value = document.createElement('td');
    value.textContent = content.Value;
    row.appendChild(value);

    table.appendChild(row);
  });

  tableContainer.appendChild(table);

  // Adjust font size after table creation
  adjustFontSize();
}

// Function to create the ODJSON table
function createODTable(data) {
  const tableContainer = document.getElementById('tableContainer');
  tableContainer.innerHTML = '';

  const table = document.createElement('table');
  table.classList.add('table');

  const headerRow = document.createElement('tr');
  const headerName = document.createElement('th');
  headerName.textContent = 'Item';
  headerRow.appendChild(headerName);

  const headerValue = document.createElement('th');
  headerValue.textContent = 'Value';
  headerRow.appendChild(headerValue);

  table.appendChild(headerRow);

  Object.entries(data).forEach(([key, value]) => {
    const row = document.createElement('tr');

    const name = document.createElement('td');
    name.textContent = key;
    row.appendChild(name);

    const val = document.createElement('td');
    val.textContent = value;
    row.appendChild(val);

    table.appendChild(row);
  });

  tableContainer.appendChild(table);

  // Adjust font size after table creation
  adjustFontSize();
}

// Function to perform search
function performSearch() {
  const searchText = document.getElementById('searchInput').value.toLowerCase().trim();

  const filteredData = omData.filter(item =>
    item.DisplayText.toLowerCase().includes(searchText)
  );

  if (filteredData.length > 0) {
    createOMTable(filteredData[0]);
    selectedData = filteredData[0];
  } else {
    const matchingItem = odData.find(odItem =>
      odItem.Item.trim().toLowerCase().includes(searchText)
    );

    if (matchingItem) {
      createODTable(matchingItem);
      selectedData = matchingItem;
    } else {
      selectedData = null;
      const tableContainer = document.getElementById('tableContainer');
      tableContainer.innerHTML = '<p>No matching results found.</p>';
    }
  }

  // Clear the search input
  document.getElementById('searchInput').value = '';

  // Scroll to the top of the table
  const resultContainer = document.getElementById('resultContainer');
  resultContainer.scrollTop = 0;

  // Update history
  pushHistory(selectedData?.Name || selectedData?.Item);
}

// Function to push selection to history
function pushHistory(item) {
  history.push(item);
  forwardHistory = [];
  historyIndex = history.length - 1;
}

// Function to navigate back in history
function navigateBack() {
  if (historyIndex > 0) {
    historyIndex--;
    const selectedItem = history[historyIndex];
    const matchingItem = omData.find(
      omItem => omItem.Name.trim().toLowerCase() === selectedItem.trim().toLowerCase()
    );

    if (matchingItem) {
      selectedData = matchingItem;
      createOMTable(matchingItem);
    } else {
      const matchingItemIndex = odData.findIndex(
        odItem => odItem.Name.trim().toLowerCase() === selectedItem.trim().toLowerCase()
      );

      if (matchingItemIndex !== -1) {
        selectedData = odData[matchingItemIndex];
        createODTable(selectedData);
      }
    }
  }
}

// Function to navigate forward in history
function navigateForward() {
  if (historyIndex < history.length - 1) {
    historyIndex++;
    const selectedItem = history[historyIndex];
    const matchingItem = omData.find(
      omItem => omItem.Name.trim().toLowerCase() === selectedItem.trim().toLowerCase()
    );

    if (matchingItem) {
      selectedData = matchingItem;
      createOMTable(matchingItem);
    } else {
      const matchingItemIndex = odData.findIndex(
        odItem => odItem.Name.trim().toLowerCase() === selectedItem.trim().toLowerCase()
      );

      if (matchingItemIndex !== -1) {
        selectedData = odData[matchingItemIndex];
        createODTable(selectedData);
      }
    }
  }
}

// Event listener for search button click
document.getElementById('searchButton').addEventListener('click', performSearch);

// Event listener for enter key press in search input
document.getElementById('searchInput').addEventListener('keydown', event => {
  if (event.key === 'Enter') {
    performSearch();
  }
});

// Event listener for back button click
document.getElementById('backButton').addEventListener('click', navigateBack);

// Event listener for forward button click
document.getElementById('forwardButton').addEventListener('click', navigateForward);

// Fetch OMJSON data and populate dropdown
fetchOMData().then(data => {
  omData = data;
  populateDropdown(data);
});

// Fetch ODJSON data
fetchODData().then(data => {
  odData = data;
});

  </script>
</body>

</html>

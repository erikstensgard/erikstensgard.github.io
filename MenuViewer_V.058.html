<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Test</title>
  <style>
    /* Common styles */
    table {
      border-collapse: collapse;
      padding: 0; /* Reduce table padding */
    }

    th,
    td {
      border: none;
      padding: 4px; /* Reduce cell padding */
    }

    .clickable {
      color: blue;
      cursor: pointer;
    }

    .bold {
      font-weight: bold;
      background-color: lightblue; /* Set your desired background color here */
    }

    /* Header styles */
    #header {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 1;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    #header button,
    #header select {
      margin: 5px;
      flex: 0 0 auto;
    }

    #goBackButton {
      margin-left: 20px;
    }

    #mainMenuButton {
      margin-right: auto;
    }

    #goForwardButton {
      margin-right: 20px;
    }

    #filterDropdown {
      margin-right: 20px;
    }

    /* Table styles */
    .table {
      table-layout: fixed;
      width: 100%;
    }

    .table td {
      white-space: nowrap; /* Disable text wrapping within a cell */
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>

</head>

<body>
  <div id="header">
    <button id="goBackButton">&larr; Go Back</button>
    <button id="mainMenuButton">Main Menu</button>
    <button id="goForwardButton">Go Forward &rarr;</button>
    <select id="filterDropdown"></select>
  </div>

  <div id="resultContainer"></div>

  <div id="footer">
    <button id="downloadJSONButton">Download JSON</button>
  </div>

  <script>
    // Fetch OMJSON Data
    async function fetchOMData() {
      const response = await fetch('MinneapolisOMJSON.json');
      const data = await response.json();
      return data;
    }

    // Fetch ODJSON Data
    async function fetchODData() {
      const response = await fetch('MinneapolisODJSON.json');
      const data = await response.json();
      return data;
    }

    // Global variables
    let omData = []; // OMJSON data
    let odData = []; // ODJSON data
    let selectedData = null; // Currently selected data
    let history = []; // History of selected items
    let forwardHistory = []; // History of forward selections
    let historyIndex = -1; // Index of the current selection in the history

    // Function to populate dropdown with OMJSON data
    function populateDropdown(data) {
      const dropdown = document.getElementById('filterDropdown');
      dropdown.innerHTML = '';

      data.sort((a, b) => {
        const displayTextA = a.DisplayText || a.Name;
        const displayTextB = b.DisplayText || b.Name;
        return displayTextA.localeCompare(displayTextB);
      });

      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.Name;
        option.textContent = item.DisplayText || item.Name;
        dropdown.appendChild(option);
      });
    }

    // Function to filter data based on selected option
    function filterData(selectedOption) {
      if (!selectedOption) {
        selectedData = omData;
      } else {
        selectedData = omData.filter(item => {
          const displayText = item.DisplayText || item.Name;
          return displayText.includes(selectedOption);
        });
      }

      createOMTable(selectedData);
    }

    // Function to create the OM table
    function createOMTable(selectedData) {
      const resultContainer = document.getElementById('resultContainer');
      resultContainer.innerHTML = '';

      const table = document.createElement('table');
      table.classList.add('table');

      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const columns = Math.max(...selectedData.map(item => item.Column));
      const screenWidth = window.innerWidth;
      const maxWidth = Math.floor(screenWidth / (columns * 2));
      const fontSize = Math.min(maxWidth, 16);
      table.style.fontSize = `${fontSize}px`;

      const thRow = document.createElement('tr');

      // Create table headers
      for (let i = 0; i <= columns; i++) {
        const th = document.createElement('th');
        th.textContent = i;
        thRow.appendChild(th);
      }

      thead.appendChild(thRow);
      table.appendChild(thead);

      // Create table body
      selectedData.forEach(item => {
        const tr = document.createElement('tr');

        for (let i = 0; i <= columns; i++) {
          const td = document.createElement('td');
          td.textContent = item[i] || '';
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      resultContainer.appendChild(table);
    }

    // Function to update the history
    function updateHistory(item) {
      const currentSelection = JSON.stringify(item);
      const previousSelection = history[historyIndex];

      if (currentSelection !== previousSelection) {
        historyIndex++;
        history = history.slice(0, historyIndex);
        history.push(currentSelection);
        forwardHistory = [];
      }
    }

    // Function to handle selection from table
    function handleSelection(event) {
      const target = event.target;
      if (target.tagName === 'TD') {
        const selectedRow = target.parentNode;
        const index = selectedRow.rowIndex;
        const selected = selectedData[index - 1];

        updateHistory(selected);
        filterData(selected.Name);
      }
    }

    // Function to navigate back in history
    function goBack() {
      if (historyIndex > 0) {
        historyIndex--;
        const previousSelection = JSON.parse(history[historyIndex]);
        filterData(previousSelection.Name);
      }
    }

    // Function to navigate forward in history
    function goForward() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const nextSelection = JSON.parse(history[historyIndex]);
        filterData(nextSelection.Name);
      }
    }

    // Function to download JSON
    function downloadJSON() {
      const filename = 'data.json';
      const data = JSON.stringify(selectedData, null, 2);

      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(data));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

    // Function to initialize the application
    async function initializeApp() {
      omData = await fetchOMData();
      odData = await fetchODData();

      populateDropdown(omData);
      filterData(null);

      const goBackButton = document.getElementById('goBackButton');
      const mainMenuButton = document.getElementById('mainMenuButton');
      const goForwardButton = document.getElementById('goForwardButton');
      const filterDropdown = document.getElementById('filterDropdown');
      const downloadJSONButton = document.getElementById('downloadJSONButton');

      goBackButton.addEventListener('click', goBack);
      mainMenuButton.addEventListener('click', () => filterData(null));
      goForwardButton.addEventListener('click', goForward);
      filterDropdown.addEventListener('change', event => filterData(event.target.value));
      downloadJSONButton.addEventListener('click', downloadJSON);

      resultContainer.addEventListener('click', handleSelection);
    }

    // Initialize the application
    initializeApp();
  </script>
</body>

</html>

